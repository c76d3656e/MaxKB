import{cr as be,cs as s,cZ as he,dk as ye,c_ as le,da as ge,cv as u,cS as Ce,cy as m,cG as $,cB as o,cC as r,cK as i,cA as l,cL as d,cw as we,cz as S,dd as Ze,cq as V,ct as ee,cu as Ke,cD as te,cE as ae,cM as Z,cF as K,cI as Je,dl as Qe,di as We,dj as Xe,cR as et,e7 as fe,dY as tt,dZ as at,de as lt,cP as ot}from"./index-a6cfd98b.js";const nt={class:"single-line"},st={class:"h-full",style:{padding:"24px 0"}},it=be({__name:"ChatRecordDrawer",props:{application:{},chatId:{},currentAbstract:{},next:{},pre:{},pre_disable:{type:Boolean},next_disable:{type:Boolean}},emits:["update:chatId","update:currentAbstract","refresh"],setup(oe,{expose:ne,emit:M}){const j=s(),{log:J}=he(),P=oe,Y=M,g=ye(),{params:{id:B}}=g,L=s(!1),A=s(!1),v=s([]),f=le({current_page:1,page_size:20,total:0});function z(){v.value=[],f.total=0,f.current_page=1}function F(){return J.asyncChatRecordLog(B,P.chatId,f,L).then(n=>{f.total=n.data.total;const b=n.data.records;v.value=[...b,...v.value].sort((C,w)=>C.create_time.localeCompare(w.create_time)),f.current_page===1&&Ze(()=>{j.value.setScrollBottom()})})}ge(()=>P.chatId,()=>{v.value=[],f.total=0,f.current_page=1,P.chatId&&F()}),ge(A,n=>{n||(Y("update:chatId",""),Y("update:currentAbstract",""),Y("refresh"))});function R(n){if(P.chatId!=="new"&&n.scrollTop===0&&f.total>v.value.length){const b=n.dialogScrollbar.offsetHeight;f.current_page+=1,F().then(()=>{n.scrollDiv.setScrollTop(n.dialogScrollbar.offsetHeight-b)})}}return ne({open:()=>{A.value=!0}}),(n,b)=>{const C=u("AiChat"),w=u("el-button"),p=u("el-drawer"),O=Ce("loading");return m(),$(p,{modelValue:A.value,"onUpdate:modelValue":b[0]||(b[0]=U=>A.value=U),size:"60%",onClose:z,class:"chat-record-drawer"},{header:o(()=>[r("h4",nt,i(n.currentAbstract),1)]),footer:o(()=>[r("div",null,[l(w,{onClick:n.pre,disabled:n.pre_disable||L.value},{default:o(()=>[d(i(n.$t("views.log.buttons.prev")),1)]),_:1},8,["onClick","disabled"]),l(w,{onClick:n.next,disabled:n.next_disable||L.value},{default:o(()=>[d(i(n.$t("views.log.buttons.next")),1)]),_:1},8,["onClick","disabled"])])]),default:o(()=>[we((m(),S("div",st,[l(C,{ref_key:"AiChatRef",ref:j,"application-details":n.application,type:"log",record:v.value,onScroll:R},null,8,["application-details","record"])])),[[O,f.current_page===1&&L.value]])]),_:1},8,["modelValue"])}}});const rt={class:"p-24"},ut={class:"mb-16"},dt={style:{display:"flex","align-items":"center"},class:"float-right"},ct={class:"filter"},pt={class:"form-item mb-16"},mt={class:"form-item mb-16"},vt={class:"text-right"},_t={key:0,class:"mr-8"},gt={key:1,class:"mr-8"},ft={key:0},bt={key:1,class:"ml-8"},ht={class:"dialog-footer",style:{"margin-top":"16px"}},yt={class:"flex align-center"},Ct={class:"dialog-footer"},wt=be({__name:"index",emits:["refresh"],setup(oe,{emit:ne}){const{application:M,log:j,document:J,user:P}=he(),Y=ye(),{params:{id:g}}=Y,B=s(),L=[{value:7,label:V("views.applicationOverview.monitor.pastDayOptions.past7Days")},{value:30,label:V("views.applicationOverview.monitor.pastDayOptions.past30Days")},{value:90,label:V("views.applicationOverview.monitor.pastDayOptions.past90Days")},{value:183,label:V("views.applicationOverview.monitor.pastDayOptions.past183Days")},{value:"other",label:V("views.applicationOverview.monitor.pastDayOptions.other")}],A=s(""),v=s({start_time:"",end_time:""}),f=s(),z=s([]),F=s(),R=s(!1),q=s(!1),n=le({current_page:1,page_size:20,total:0}),b=s(!1),C=s(!1),w=s(180),p=s([]),O=ee(()=>p.value.map((e,t)=>({[e.id]:t})).reduce((e,t)=>({...e,...t}),{})),U=s(7),T=s(""),H=s(null),_=s(""),I=s(""),G=s(!1),ke={min_star:0,min_trample:0,comparer:"and"},k=s({min_star:0,min_trample:0,comparer:"and"}),c=s({dataset_id:"",document_id:""}),De=le({dataset_id:[{required:!0,message:V("views.log.selectDatasetPlaceholder"),trigger:"change"}],document_id:[{required:!0,message:V("views.log.documentPlaceholder"),trigger:"change"}]}),se=s(!1),Q=s([]);function ie(e){e==="clear"&&(k.value=et.cloneDeep(ke)),D(),G.value=!1}const Ve=()=>{let e=O.value[_.value]+1;if(e>=p.value.length){if(e+(n.current_page-1)*n.page_size>=n.total-1)return;n.current_page=n.current_page+1,D().then(()=>{e=0,_.value=p.value[e].id,I.value=p.value[e].abstract})}else _.value=p.value[e].id,I.value=p.value[e].abstract},$e=ee(()=>O.value[_.value]-1<0&&n.current_page<=1),Se=ee(()=>{let e=O.value[_.value]+1;return e>=p.value.length&&e+(n.current_page-1)*n.page_size>=n.total-1}),Ae=()=>{let e=O.value[_.value]-1;if(e<0){if(n.current_page<=1)return;n.current_page=n.current_page-1,D().then(()=>{e=n.page_size-1,_.value=p.value[e].id,I.value=p.value[e].abstract})}else _.value=p.value[e].id,I.value=p.value[e].abstract};function Re(e,t){t&&t.type==="selection"||(_.value=e.id,I.value=e.abstract,F.value.open())}const Ie=({row:e})=>_.value===(e==null?void 0:e.id)?"highlight":"",Le=e=>{z.value=e};function D(){let e={start_time:v.value.start_time,end_time:v.value.end_time,...k.value};return T.value&&(e={...e,abstract:T.value}),j.asyncGetChatLog(g,n,e,R).then(t=>{var h;p.value=t.data.records,_.value&&(_.value=(h=p.value[0])==null?void 0:h.id),n.total=t.data.total})}function re(){M.asyncGetApplicationDetail(g,R).then(e=>{H.value=e.data,w.value=e.data.clean_time})}const ze=()=>{const e=[];if(z.value.map(t=>{t&&e.push(t.id)}),H.value){let t={start_time:v.value.start_time,end_time:v.value.end_time,...k.value};T.value&&(t={...t,abstract:T.value}),fe.exportChatLog(H.value.id,H.value.name,t,{select_ids:e},R)}};function Oe(){D()}function Ue(e){v.value.start_time=e[0],v.value.end_time=e[1],D()}function ue(e){e!=="other"&&(v.value.start_time=tt(e),v.value.end_time=at,D())}function Te(){const e={clean_time:w.value};M.asyncPutApplication(g,e,R).then(()=>{lt(V("common.saveSuccess")),b.value=!1,re()}).catch(()=>{b.value=!1})}function xe(e){localStorage.setItem(g+"chat_dataset_id",e),c.value.document_id="",de(e)}function Me(e){localStorage.setItem(g+"chat_document_id",e)}const W=s([]);function Pe(){M.asyncGetApplicationDataset(g,q).then(e=>{W.value=e.data,localStorage.getItem(g+"chat_dataset_id")&&(c.value.dataset_id=localStorage.getItem(g+"chat_dataset_id"),W.value.find(t=>t.id===c.value.dataset_id)?de(c.value.dataset_id):(c.value.dataset_id="",c.value.document_id=""))})}const Ye=async e=>{if(!e)return;const t=[];z.value.map(h=>{h&&t.push(h.id)}),await e.validate(h=>{if(h){const N={document_id:c.value.document_id,dataset_id:c.value.dataset_id,chat_ids:t};fe.postChatRecordLog(g,c.value.dataset_id,N,q).then(ce=>{var E;(E=f.value)==null||E.clearSelection(),C.value=!1})}})};function de(e){J.asyncGetAllDocument(e,q).then(t=>{Q.value=t.data,localStorage.getItem(g+"chat_document_id")&&(c.value.document_id=localStorage.getItem(g+"chat_document_id")),Q.value.find(h=>h.id===c.value.document_id)||(c.value.document_id="")})}function Be(){var e;Pe(),(e=B.value)==null||e.clearValidate(),C.value=!0}return Ke(()=>{ue(U.value),re()}),(e,t)=>{const h=u("el-option"),N=u("el-select"),ce=u("el-date-picker"),E=u("el-input"),y=u("el-button"),x=u("el-table-column"),Fe=u("Filter"),qe=u("el-icon"),X=u("el-input-number"),He=u("el-popover"),pe=u("AppIcon"),Ne=u("app-table"),me=u("el-dialog"),ve=u("AppAvatar"),_e=u("el-form-item"),je=u("el-form"),Ge=u("LayoutContainer"),Ee=Ce("loading");return m(),$(Ge,{header:e.$t("views.log.title")},{default:o(()=>[r("div",rt,[r("div",ut,[l(N,{modelValue:U.value,"onUpdate:modelValue":t[0]||(t[0]=a=>U.value=a),class:"mr-12 w-120",onChange:ue},{default:o(()=>[(m(),S(te,null,ae(L,a=>l(h,{key:a.value,label:a.label,value:a.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"]),U.value==="other"?(m(),$(ce,{key:0,modelValue:A.value,"onUpdate:modelValue":t[1]||(t[1]=a=>A.value=a),type:"daterange","start-placeholder":e.$t("views.applicationOverview.monitor.startDatePlaceholder"),"end-placeholder":e.$t("views.applicationOverview.monitor.endDatePlaceholder"),format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",onChange:Ue},null,8,["modelValue","start-placeholder","end-placeholder"])):Z("",!0),l(E,{modelValue:T.value,"onUpdate:modelValue":t[2]||(t[2]=a=>T.value=a),onChange:D,placeholder:e.$t("common.search"),"prefix-icon":"Search",class:"w-240",clearable:""},null,8,["modelValue","placeholder"]),r("div",dt,[l(y,{onClick:t[3]||(t[3]=a=>b.value=!0)},{default:o(()=>[d(i(e.$t("views.log.buttons.clearStrategy")),1)]),_:1}),l(y,{onClick:ze},{default:o(()=>[d(i(e.$t("common.export")),1)]),_:1}),l(y,{onClick:Be,disabled:z.value.length===0},{default:o(()=>[d(i(e.$t("views.log.addToDataset")),1)]),_:1},8,["disabled"])])]),we((m(),$(Ne,{data:p.value,"pagination-config":n,onSizeChange:D,onChangePage:D,onRowClick:Re,"row-class-name":Ie,onSelectionChange:Le,class:"log-table",ref_key:"multipleTableRef",ref:f},{default:o(()=>[l(x,{type:"selection",width:"55"}),l(x,{prop:"abstract",label:e.$t("views.log.table.abstract"),"show-overflow-tooltip":""},null,8,["label"]),l(x,{prop:"chat_record_count",label:e.$t("views.log.table.chat_record_count"),align:"right"},null,8,["label"]),l(x,{prop:"star_num",align:"right"},{header:o(()=>[r("div",null,[r("span",null,i(e.$t("views.log.table.feedback.label")),1),l(He,{width:200,trigger:"click",visible:G.value},{reference:o(()=>[l(y,{style:{"margin-top":"-2px"},type:k.value.min_star||k.value.min_trample?"primary":"",link:"",onClick:t[4]||(t[4]=a=>G.value=!G.value)},{default:o(()=>[l(qe,null,{default:o(()=>[l(Fe)]),_:1})]),_:1},8,["type"])]),default:o(()=>[r("div",ct,[r("div",pt,[r("div",{onClick:t[6]||(t[6]=K(()=>{},["stop"]))},[d(i(e.$t("views.log.table.feedback.star"))+" >= ",1),l(X,{modelValue:k.value.min_star,"onUpdate:modelValue":t[5]||(t[5]=a=>k.value.min_star=a),min:0,step:1,"value-on-clear":0,"controls-position":"right",style:{width:"80px"},size:"small","step-strictly":""},null,8,["modelValue"])])]),r("div",mt,[r("div",{onClick:t[8]||(t[8]=K(()=>{},["stop"]))},[d(i(e.$t("views.log.table.feedback.trample"))+" >= ",1),l(X,{modelValue:k.value.min_trample,"onUpdate:modelValue":t[7]||(t[7]=a=>k.value.min_trample=a),min:0,step:1,"value-on-clear":0,"controls-position":"right",style:{width:"80px"},size:"small","step-strictly":""},null,8,["modelValue"])])])]),r("div",vt,[l(y,{size:"small",onClick:t[9]||(t[9]=a=>ie("clear"))},{default:o(()=>[d(i(e.$t("common.clear")),1)]),_:1}),l(y,{type:"primary",onClick:ie,size:"small"},{default:o(()=>[d(i(e.$t("common.confirm")),1)]),_:1})])]),_:1},8,["visible"])])]),default:o(({row:a})=>[!a.trample_num&&!a.star_num?(m(),S("span",_t," - ")):(m(),S("span",gt,[a.star_num?(m(),S("span",ft,[l(pe,{iconName:"app-like-color"}),d(" "+i(a.star_num),1)])):Z("",!0),a.trample_num?(m(),S("span",bt,[l(pe,{iconName:"app-oppose-color"}),d(" "+i(a.trample_num),1)])):Z("",!0)]))]),_:1}),l(x,{prop:"mark_sum",label:e.$t("views.log.table.mark"),align:"right"},null,8,["label"]),l(x,{label:e.$t("views.log.table.recenTimes"),width:"180"},{default:o(({row:a})=>[d(i(Je(Qe)(a.update_time)),1)]),_:1},8,["label"])]),_:1},8,["data","pagination-config"])),[[Ee,R.value]])]),l(it,{next:Ve,pre:Ae,ref_key:"ChatRecordRef",ref:F,chatId:_.value,"onUpdate:chatId":t[10]||(t[10]=a=>_.value=a),currentAbstract:I.value,"onUpdate:currentAbstract":t[11]||(t[11]=a=>I.value=a),application:H.value,pre_disable:$e.value,next_disable:Se.value,onRefresh:Oe},null,8,["chatId","currentAbstract","application","pre_disable","next_disable"]),l(me,{title:e.$t("views.log.buttons.clearStrategy"),modelValue:b.value,"onUpdate:modelValue":t[14]||(t[14]=a=>b.value=a),width:"25%","close-on-click-modal":!1,"close-on-press-escape":!1},{footer:o(()=>[r("div",ht,[l(y,{onClick:t[13]||(t[13]=a=>b.value=!1)},{default:o(()=>[d(i(e.$t("common.cancel")),1)]),_:1}),l(y,{type:"primary",onClick:Te},{default:o(()=>[d(i(e.$t("common.save")),1)]),_:1})])]),default:o(()=>[r("span",null,i(e.$t("common.delete")),1),l(X,{modelValue:w.value,"onUpdate:modelValue":t[12]||(t[12]=a=>w.value=a),"controls-position":"right",min:1,max:1e5,"value-on-clear":0,"step-strictly":"",style:{width:"110px","margin-left":"8px","margin-right":"8px"}},null,8,["modelValue"]),r("span",null,i(e.$t("views.log.daysText")),1)]),_:1},8,["title","modelValue"]),l(me,{title:e.$t("views.log.addToDataset"),modelValue:C.value,"onUpdate:modelValue":t[20]||(t[20]=a=>C.value=a),width:"50%","close-on-click-modal":!1,"close-on-press-escape":!1},{footer:o(()=>[r("span",Ct,[l(y,{onClick:t[18]||(t[18]=K(a=>C.value=!1,["prevent"]))},{default:o(()=>[d(i(e.$t("common.cancel")),1)]),_:1}),l(y,{type:"primary",onClick:t[19]||(t[19]=a=>Ye(B.value)),loading:q.value},{default:o(()=>[d(i(e.$t("common.save")),1)]),_:1},8,["loading"])])]),default:o(()=>[l(je,{ref_key:"formRef",ref:B,model:c.value,"label-position":"top","require-asterisk-position":"right",rules:De,onSubmit:t[17]||(t[17]=K(()=>{},["prevent"]))},{default:o(()=>[l(_e,{label:e.$t("views.log.selectDataset"),prop:"dataset_id"},{default:o(()=>[l(N,{modelValue:c.value.dataset_id,"onUpdate:modelValue":t[15]||(t[15]=a=>c.value.dataset_id=a),filterable:"",placeholder:e.$t("views.log.selectDatasetPlaceholder"),loading:se.value,onChange:xe},{default:o(()=>[(m(!0),S(te,null,ae(W.value,a=>(m(),$(h,{key:a.id,label:a.name,value:a.id},{default:o(()=>[r("span",yt,[!a.dataset_id&&a.type==="1"?(m(),$(ve,{key:0,class:"mr-12 avatar-purple",shape:"square",size:24},{default:o(()=>t[21]||(t[21]=[r("img",{src:We,style:{width:"58%"},alt:""},null,-1)])),_:1})):!a.dataset_id&&a.type==="0"?(m(),$(ve,{key:1,class:"mr-12 avatar-blue",shape:"square",size:24},{default:o(()=>t[22]||(t[22]=[r("img",{src:Xe,style:{width:"58%"},alt:""},null,-1)])),_:1})):Z("",!0),d(" "+i(a.name),1)])]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue","placeholder","loading"])]),_:1},8,["label"]),l(_e,{label:e.$t("views.log.saveToDocument"),prop:"document_id"},{default:o(()=>[l(N,{modelValue:c.value.document_id,"onUpdate:modelValue":t[16]||(t[16]=a=>c.value.document_id=a),filterable:"",placeholder:e.$t("views.log.documentPlaceholder"),loading:se.value,onChange:Me},{default:o(()=>[(m(!0),S(te,null,ae(Q.value,a=>(m(),$(h,{key:a.id,label:a.name,value:a.id},{default:o(()=>[d(i(a.name),1)]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue","placeholder","loading"])]),_:1},8,["label"])]),_:1},8,["model","rules"])]),_:1},8,["title","modelValue"])]),_:1},8,["header"])}}});const Dt=ot(wt,[["__scopeId","data-v-05dfb095"]]);export{Dt as default};
